= Secrets Management with HashiCorp Vault

== Overview

This module covers the implementation of HashiCorp Vault for secrets management in OpenShift,
including installation,
configuration,
and practical workflows for managing application secrets.

== Learning Objectives

By the end of this module,
you will be able to:

* Install and configure HashiCorp Vault in OpenShift
* Understand Vault's architecture and security model
* Create and manage secrets for applications
* Implement automatic secret rotation
* Integrate Vault with OpenShift applications
* Monitor and audit secret access

== Prerequisites

* OpenShift cluster with admin access
* `oc` command line tool installed
* Basic understanding of Kubernetes/OpenShift concepts
* Familiarity with command line operations

== Module Structure

=== 1. Vault Installation and Setup
==== 1.1 Installing Vault in OpenShift
==== 1.2 Configuring Vault for Production Use
==== 1.3 Setting up Authentication and Authorization

=== 2. Vault Fundamentals
==== 2.1 Understanding Vault Architecture
==== 2.2 Key Vault Concepts (Secrets
Policies
Tokens)
==== 2.3 Security Model and Best Practices

=== 3. Secrets Management Workflows
==== 3.1 Creating and Storing Secrets
==== 3.2 Retrieving Secrets in Applications
==== 3.3 Secret Rotation Strategies
==== 3.4 Dynamic Secrets and Credentials

=== 4. OpenShift Integration
==== 4.1 Service Account Integration
==== 4.2 ConfigMap and Secret Management
==== 4.3 Application Deployment with Vault

=== 5. Advanced Features
==== 5.1 Audit Logging and Monitoring
==== 5.2 Disaster Recovery and Backup
==== 5.3 Multi-cluster Vault Deployment

== Lab Exercises

=== Exercise 1: Vault Installation
# Add HashiCorp charts

oc delete project vault
oc delete clusterrole vault-agent-injector-clusterrole
oc delete clusterrolebinding vault-agent-injector-binding
oc delete clusterrolebinding vault-server-binding
oc delete mutatingwebhookconfiguration vault-agent-injector-cfg

# 1) Create a namespace
oc new-project vault

# 2) Install Vault in dev mode + OpenShift route for the UI

cat <<EOF > values-ha.yaml
global:
  openshift: true        # turn on OpenShift-aware bits (SCC/Route helpers)
  tlsDisable: true       # simple start (HTTP behind an edge-terminated Route)
                         # For end-to-end TLS
                         set this to false and configure certs.

server:
  ha:
    enabled: true
    replicas: 3
    raft:
      enabled: true
      setNodeId: true
      # Minimal Vault config (HTTP listener; see TLS note above)
      config: |
        ui = true
        listener "tcp" {
          tls_disable    = 1
          address        = "[::]:8200"
          cluster_address = "[::]:8201"
        }
        storage "raft" { path = "/vault/data" }
        service_registration "kubernetes" {}

  dataStorage:
    enabled: true
    size: 10Gi           # adjust for your needs

  ui:
    enabled: true

  route:
    enabled: true
    host: vault.apps.cluster-s565v.s565v.sandbox2437.opentlc.com   # <-- set this
    tls:
      termination: edge              # HTTP at Vault; TLS at router

  # Give Vault the right to validate SA tokens (for k8s auth
  injectors
  etc.)
  authDelegator:
    enabled: true

EOF


helm install vault hashicorp/vault -n vault -f values-ha.yaml


oc exec -ti vault-0 -n vault -- vault operator unseal 7Z3hhxozXmd1C/NistAVksVyet+AUKRzOx1RCobAU1Q=
oc exec -ti vault-1 -n vault -- vault operator unseal 7Z3hhxozXmd1C/NistAVksVyet+AUKRzOx1RCobAU1Q=
oc exec -ti vault-2 -n vault -- vault operator unseal 7Z3hhxozXmd1C/NistAVksVyet+AUKRzOx1RCobAU1Q=




=== Exercise 2: Basic Secrets Management
Create
store
and retrieve secrets using Vault's key-value store.

=== Exercise 3: Application Integration
Deploy a sample application that retrieves secrets from Vault at runtime.

=== Exercise 4: Secret Rotation
Implement automatic secret rotation for database credentials.

=== Exercise 5: Monitoring and Auditing
Set up monitoring and audit logging for Vault operations.

== Next Steps

After completing this module
you can explore:

* Advanced Vault features like Transit encryption
* Integration with CI/CD pipelines
* Multi-cloud secrets management
* Compliance and governance frameworks

== Additional Resources

* link:https://www.vaultproject.io/docs[Vault Documentation]
* link:https://www.vaultproject.io/docs/platform/k8s[Vault on Kubernetes]
* link:https://www.vaultproject.io/docs/concepts[Vault Concepts]
* link:https://www.vaultproject.io/docs/concepts/policies[Vault Policies] 

