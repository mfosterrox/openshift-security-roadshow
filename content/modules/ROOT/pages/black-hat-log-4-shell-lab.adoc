== RHACS Log4Shell Vulnerability Quick Lab

This lab shows how to block workloads with Log4Shell vulnerabilities using Red Hat Advanced Cluster Security (RHACS).

.Goals
* Block the vulnerable deployment of a log4shell application
* Craft a policy to block the deployment of any application that uses log4shell
* Verify the policy in the RHACS console

== 1. Clean Up Environment

Run these commands to reset your environment:

[source,sh,role=execute]
----
if oc get project log4shell &>/dev/null; then
  oc delete project log4shell
else
  echo "Project 'log4shell' already cleaned up."
fi

if [ -f ~/deploy.yaml ]; then
  rm -f ~/deploy.yaml
else
  echo "'~/deploy.yaml' already cleaned up."
fi

POL_ID=$(curl -k -H "Authorization: Bearer $ROX_API_TOKEN" "https://$ROX_CENTRAL_ADDRESS/v1/policies" | jq -r '.policies[] | select(.isDefault|not) | .id')
if [ -n "$POL_ID" ] && [ "$POL_ID" != "null" ]; then
  curl -k -X DELETE -H "Authorization: Bearer $ROX_API_TOKEN" "https://$ROX_CENTRAL_ADDRESS/v1/policies/$POL_ID"
else
  echo "Policy already cleaned up."
fi
----

== 2. Deploy Vulnerable Application

Awesome! You're ready to go. Now, create a new project and deploy the vulnerable Log4Shell app:

[source,sh,role=execute]
----
oc new-project log4shell
cat << EOF > ~/deploy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: log4shell
  namespace: log4shell
spec:
  replicas: 1
  selector:
    matchLabels:
      deployment: log4shell
  template:
    metadata:
      labels:
        deployment: log4shell
    spec:
      containers:
      - name: log4shell
        image: quay.io/rhacs-misc/log4shell:1.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          protocol: TCP
      restartPolicy: Always
EOF
oc create -f ~/deploy.yaml
----

Check the pod status:

[source,sh,role=execute]
----
oc get pods -l deployment=log4shell -n log4shell
----

NOTE: You can add -w to the command to watch the pod status.

[.console-output]
[source,sh]
----
[lab-user@bastion ~]$ oc get pods -l deployment=log4shell -n log4shell
NAME                         READY   STATUS              RESTARTS   AGE
log4shell-6454cfb8c9-whskt   0/1     ContainerCreating   0          9s
log4shell-6454cfb8c9-whskt   1/1     Running             0          12s
----



== 3. Verify Vulnerability

Scan the image to confirm the Log4Shell vulnerability is present:

[source,sh,role=execute]
----
roxctl --insecure-skip-tls-verify -e "$ROX_CENTRAL_ADDRESS:443" image scan --image=quay.io/rhacs-misc/log4shell:1.0 --force -o table --severity=CRITICAL
----

Look for CVE-2021-44228 in the output.

== 4. Review the Vulnerability in the RHACS Console

Quickly identifying a vulnerability with RHACS enables you to proactively protect your workloads, minimize risk, and respond to security threats before they can be exploited.

1. In the RHACS console, go to the **Vulnerabilities** page.
2. Filter for the Log4Shell CVE (CVE-2021-44228).
3. Click on the vulnerability to see the details.
4. Click on the **Vulnerable Workloads** tab to see the workloads that are vulnerable.


== 5. Test Deployment Policy Enforcement

Try to redeploy the vulnerable app:

[source,sh,role=execute]
----
oc create -f ~/deploy.yaml
----

You should see an error saying the deployment is blocked by the Log4Shell policy.

== 6. Review Violations

1. In the RHACS console, go to the **Violations** page.
2. Filter for the Log4Shell policy to see the blocked deployment event.

== 7. Clean Up

Run these commands to clean up:

[source,sh,role=execute]
----
oc delete project log4shell || true
rm -f ~/deploy.yaml
ROX_CENTRAL_ADDRESS=$(oc -n stackrox get route central -o jsonpath='{.spec.host}')
POL_ID=$(curl -k -H "Authorization: Bearer $ROX_API_TOKEN" "https://$ROX_CENTRAL_ADDRESS/v1/policies" | jq -r '.policies[] | select(.isDefault|not) | .id')
curl -k -X DELETE -H "Authorization: Bearer $ROX_API_TOKEN" "https://$ROX_CENTRAL_ADDRESS/v1/policies/$POL_ID"
----

---

Lab complete! You have enforced and tested Log4Shell protection with RHACS.
